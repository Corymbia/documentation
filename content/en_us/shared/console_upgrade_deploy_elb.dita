<?xml version="1.0" encoding="UTF-8"?>
<!--This work by Eucalyptus Systems is licensed under a Creative Commons Attribution-ShareAlike 3.0 Unported License. See the accompanying LICENSE file for more information.-->
<!DOCTYPE task PUBLIC "-//OASIS//DTD DITA Task//EN" "task.dtd">
<task id="console_upgrade_console">
    <title>Upgrade the Management Console Behind an ELB</title>
    <shortdesc>This section describes the process for deploying the console behind a load balancer (ELB).
    </shortdesc>
    
    <taskbody>
        
        <context>
            <p>To run the console behind a load balancer:</p>
        </context>
        <steps>
            <step>
                <cmd>If you don't have a CentOS 6.x image on your cloud, perform the following steps to install one:</cmd>
                <substeps>
                    <substep id="step_download_centos_image">
                        <cmd>Download a CentOS 6.x image from the <xref href="http://emis.eucalyptus.com"
                            scope="external" format="html">Eucalyptus Machine Image Catalog</xref>.</cmd>
                        <info><note>Keep its ID handy as it will be required in the subsequent steps.</note></info>
                    </substep>
                    <substep>
                        <cmd>Install the image onto your cloud. For more information, see 
                            <xref href="../image-guide/img_task_install_hvm_image.dita"></xref></cmd>
                    </substep>
                </substeps>
            </step>
            <step>
                <cmd>Create or import an SSH key. For more information, see <xref
                    href="../user-guide/create_keypairs.dita"/> or 
                    <xref href="../euca2ools-guide/euca-import-keypair.dita"></xref>.</cmd>
            </step>
            <step>
                <cmd>Create the console stack using a pre-defined template from the eucaconsole github repository:</cmd>
                <substeps>
                    <substep id="step_create_stack">
                        <cmd>In the terminal command line, run the following command using your own ssh key name, 
                            the image ID (from step <xref href="#console_upgrade_console/step_download_centos_image" type="li" />),
                          instance type, and your cloud’s fully qualified domain name (FQDN):</cmd>
                        <info>
                            <codeblock>euform-create-stack —template-url https://raw.githubusercontent.com/eucalyptus/eucaconsole/maint-4.2/scripts/console-deploy.cfn eucaconsole-stack -p KeyName=dak-ssh-key -p ImageId=emi-2fb14ad7 -p InstanceType=m3.2xlarge -p CloudIP=a-09.autoqa.qa1.eucalyptus-systems.com</codeblock>
                            <note>The InstanceType shown in the above is only an example of the size of the image chosen. The image type (size) you choose could be smaller, since that size could serve 1000 users.</note>
                        </info>
                    </substep>
                </substeps>
            </step>
            <step>
                <cmd>Create an SSL certificate using the domain name for the ELB:</cmd>
                <substeps>
                    <substep>
                        <cmd> run <codeph>euform-describe-stacks eucaconsole-stack</codeph> 
                            to obtain the domain name from the resulting output URL.</cmd>
                    </substep>
                    <substep>
                        <cmd>See <xref
                            href="../admin-guide/configuring_ssl.dita"/> to create an SSL certificate.</cmd>
                    </substep>
                </substeps>
            </step>
            <step>
                <cmd>Upload the SSL certificate by running the command:</cmd>
                <info><codeblock>euare-servercertupload –s eucaconsole-cert —private-key-file &lt;<varname>console-pk.pem</varname>&gt; —certificate-file &lt;<varname>console.crt</varname>&gt;</codeblock></info>
            </step>
            <step>
                <cmd>Add the HTTPS listener to your ELB:</cmd>
                <substeps>
                    <substep>
                        <cmd>Obtain the SSL certificate ARN by running the command:</cmd>
                        <info><codeblock>euare-servercertgetattributes –s eucaconsole-cert</codeblock></info>
                    </substep>
                    <substep>
                        <cmd>Then add the listener by runnng the command:</cmd>
                        <info><codeblock>eulb-create-lb-listeners &lt;elb-name&gt; --listener "protocol=HTTPS,lb-port=443,instance-port=443,instance-protocol=HTTPS,cert-id=&lt;cert-arn&gt;”</codeblock></info>
                        <stepresult>Now you should be able to reach the console via "https://&lt;cloudIP&gt;” 
                            (the FQDN you provided when creating the stack in step <xref href="#console_upgrade_console/step_create_stack" type="li" />).</stepresult>
                    </substep>
                    
                </substeps>
            </step>
        </steps>
    </taskbody>
    
</task>
